steps:

# https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values
- id: build docker image
  name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'europe-west2-docker.pkg.dev/$PROJECT_ID/my-docker-repo/${_APP_NAME}:${_APP_TAG}', '.']

- id: upload docker image to GAR
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'europe-west2-docker.pkg.dev/$PROJECT_ID/my-docker-repo/${_APP_NAME}:${_APP_TAG}']


  # to prepare ssh private key file
- id: prepare ssh private key file
  name: 'ubuntu'
  entrypoint: bash
  args:
    - '-c'
    - |
      echo ${SSH_PRIVATE_KEY} | cut -c 1-30
      echo ${SSH_PRIVATE_KEY} > /workspace/ssh_key_file
      echo ${SSH_PUBLIC_KEY} > /workspace/ssh_key_file.pub
      chmod 600 /workspace/ssh_key_file
      chmod 600 /workspace/ssh_key_file.pub
  secretEnv:
    - 'SSH_PRIVATE_KEY'
    - 'SSH_PUBLIC_KEY'



# https://stackoverflow.com/questions/68779751/error-publishing-source-code-from-cloud-build-to-a-bucket-using-triggers
logsBucket: gs://jason-hsbc_cloudbuild/logs/
options: # https://cloud.google.com/cloud-build/docs/build-config#options
  logging: GCS_ONLY # or CLOUD_LOGGING_ONLY https://cloud.google.com/cloud-build/docs/build-config#logging

# to define
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/gateman-private-ssh-key/versions/latest
      env: 'SSH_PRIVATE_KEY'
    - versionName: projects/$PROJECT_ID/secrets/gateman-public-ssh-key/versions/latest
      env: 'SSH_PUBLIC_KEY'

substitutions:
  _APP_NAME: sonarqube-server
  _APP_TAG: latest
  _VM_HOST: "tf-vpc0-subnet0-vm0"